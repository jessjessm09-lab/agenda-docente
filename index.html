import React, { useState, useEffect } from 'react';
import { School, BookOpen, Calendar, Users, ClipboardList, Clock, Plus, ArrowLeft, Save, Trash2, Check, Palette, ChevronLeft, ChevronRight, Edit2, FileText } from 'lucide-react';

const AgendaDocente = () => {
  const [pantalla, setPantalla] = useState('inicio');
  const [docente, setDocente] = useState('');
  const [escuelas, setEscuelas] = useState([]);
  const [idEscuela, setIdEscuela] = useState(null);
  const [materias, setMaterias] = useState({});
  const [idMateria, setIdMateria] = useState(null);
  const [cursos, setCursos] = useState({});
  const [idCurso, setIdCurso] = useState(null);
  const [alumnos, setAlumnos] = useState({});
  const [idAlumno, setIdAlumno] = useState(null);
  const [asistencias, setAsistencias] = useState({});
  const [notas, setNotas] = useState({});
  const [libroTemas, setLibroTemas] = useState({});
  const [tema, setTema] = useState('azul');
  
  const [textoEscuela, setTextoEscuela] = useState('');
  const [textoMateria, setTextoMateria] = useState('');
  const [textoCurso, setTextoCurso] = useState('');
  const [textoAlumno, setTextoAlumno] = useState('');
  const [fechaAsist, setFechaAsist] = useState('');
  const [estadoAsist, setEstadoAsist] = useState('');
  const [trimestreNota, setTrimestreNota] = useState('1');
  const [tipoNota, setTipoNota] = useState('tp');
  const [valorNota, setValorNota] = useState('');
  const [fechaNota, setFechaNota] = useState('');
  const [descripcionNota, setDescripcionNota] = useState('');
  const [formLibro, setFormLibro] = useState(false);
  const [registroLibro, setRegistroLibro] = useState({
    fecha: '', asignatura: '', horas: '', unidad: '',
    alumnosPresentes: '', alumnosAusentes: '',
    contenidos: '', actividades: '', observaciones: '', folio: ''
  });
  const [horarios, setHorarios] = useState({});
  const [editandoHorario, setEditandoHorario] = useState(null);
  const [textoHorario, setTextoHorario] = useState('');
  const [horasPersonalizadas, setHorasPersonalizadas] = useState({});
  const [editandoRangoHora, setEditandoRangoHora] = useState(null);
  const [rangoHorario, setRangoHorario] = useState('');
  
  const [eventosCalendario, setEventosCalendario] = useState({});
  const [mesActual, setMesActual] = useState(new Date());
  const [diaSeleccionado, setDiaSeleccionado] = useState(null);
  const [textoEvento, setTextoEvento] = useState('');
  const [tipoEvento, setTipoEvento] = useState('general');
  const [notasPlanner, setNotasPlanner] = useState({});

  const colores = {
    azul: { n: 'Azul', p: 'bg-blue-600', s: 'bg-blue-100', t: 'text-blue-600', g: 'from-blue-500 to-blue-600' },
    verde: { n: 'Verde', p: 'bg-green-600', s: 'bg-green-100', t: 'text-green-600', g: 'from-green-500 to-green-600' },
    purpura: { n: 'Púrpura', p: 'bg-purple-600', s: 'bg-purple-100', t: 'text-purple-600', g: 'from-purple-500 to-purple-600' },
    gris: { n: 'Gris', p: 'bg-slate-700', s: 'bg-slate-100', t: 'text-slate-700', g: 'from-slate-600 to-slate-700' }
  };

  const col = colores[tema];

  useEffect(() => {
    cargar();
  }, []);

  const cargar = async () => {
    try {
      const datos = await Promise.all([
        window.storage.get('docente'),
        window.storage.get('escuelas'),
        window.storage.get('materias'),
        window.storage.get('cursos'),
        window.storage.get('alumnos'),
        window.storage.get('asistencias'),
        window.storage.get('notas'),
        window.storage.get('libroTemas'),
        window.storage.get('tema'),
        window.storage.get('horarios'),
        window.storage.get('horasPersonalizadas'),
        window.storage.get('eventosCalendario'),
        window.storage.get('notasPlanner')
      ]);
      
      if (datos[0]?.value) setDocente(datos[0].value);
      if (datos[1]?.value) setEscuelas(JSON.parse(datos[1].value));
      if (datos[2]?.value) setMaterias(JSON.parse(datos[2].value));
      if (datos[3]?.value) setCursos(JSON.parse(datos[3].value));
      if (datos[4]?.value) setAlumnos(JSON.parse(datos[4].value));
      if (datos[5]?.value) setAsistencias(JSON.parse(datos[5].value));
      if (datos[6]?.value) setNotas(JSON.parse(datos[6].value));
      if (datos[7]?.value) setLibroTemas(JSON.parse(datos[7].value));
      if (datos[8]?.value) setTema(datos[8].value);
      if (datos[9]?.value) setHorarios(JSON.parse(datos[9].value));
      if (datos[10]?.value) setHorasPersonalizadas(JSON.parse(datos[10].value));
      if (datos[11]?.value) setEventosCalendario(JSON.parse(datos[11].value));
      if (datos[12]?.value) setNotasPlanner(JSON.parse(datos[12].value));
    } catch (err) {
      console.log('Primera vez');
    }
  };

  const guardar = async (clave, valor) => {
    try {
      const dato = typeof valor === 'string' ? valor : JSON.stringify(valor);
      await window.storage.set(clave, dato);
    } catch (err) {
      console.error('Error:', err);
    }
  };

  const irInicio = () => {
    setPantalla('inicio');
    setIdEscuela(null);
    setIdMateria(null);
    setIdCurso(null);
    setIdAlumno(null);
  };

  switch(pantalla) {
    case 'inicio':
      return (
        <div className="min-h-screen bg-gray-50 p-4">
          <div className="max-w-2xl mx-auto space-y-4">
            <div className={`bg-gradient-to-r ${col.g} text-white p-6 rounded-lg shadow-lg`}>
              <h1 className="text-3xl font-bold mb-2">Agenda Docente</h1>
              {docente ? (
                <p className="text-xl">Prof. {docente}</p>
              ) : (
                <input 
                  type="text"
                  placeholder="Tu nombre"
                  onBlur={(e) => {
                    if (e.target.value.trim()) {
                      setDocente(e.target.value);
                      guardar('docente', e.target.value);
                    }
                  }}
                  className="w-full p-2 rounded text-gray-800"
                />
              )}
            </div>
            <button 
              onClick={() => setPantalla('planner-mensual')}
              className="w-full bg-white p-6 rounded-lg shadow hover:shadow-md flex items-center justify-center gap-3">
              <Calendar className={`w-10 h-10 ${col.t}`} />
              <span className="text-xl font-semibold">Planner Mensual</span>
            </button>
            <button 
              onClick={() => setPantalla('lista-escuelas')}
              className="w-full bg-white p-6 rounded-lg shadow hover:shadow-md flex items-center justify-center gap-3">
              <School className={`w-10 h-10 ${col.t}`} />
              <span className="text-xl font-semibold">Mis Escuelas</span>
            </button>
            <button 
              onClick={() => setPantalla('config-tema')}
              className="w-full bg-white p-4 rounded-lg shadow hover:shadow-md flex items-center justify-center gap-2">
              <Palette className="w-6 h-6" />
              <span>Cambiar Tema</span>
            </button>
          </div>
        </div>
      );

    case 'planner-mensual':
      const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      const diasSemana = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
      
      const obtenerDiasDelMes = (fecha) => {
        const año = fecha.getFullYear();
        const mes = fecha.getMonth();
        const primerDia = new Date(año, mes, 1);
        const ultimoDia = new Date(año, mes + 1, 0);
        const diasEnMes = ultimoDia.getDate();
        const primerDiaSemana = primerDia.getDay();
        
        const dias = [];
        for (let i = 0; i < primerDiaSemana; i++) {
          dias.push(null);
        }
        for (let i = 1; i <= diasEnMes; i++) {
          dias.push(i);
        }
        return dias;
      };

      const formatearFecha = (dia) => {
        const año = mesActual.getFullYear();
        const mes = String(mesActual.getMonth() + 1).padStart(2, '0');
        const d = String(dia).padStart(2, '0');
        return `${año}-${mes}-${d}`;
      };

      const mesAnterior = () => {
        const nueva = new Date(mesActual);
        nueva.setMonth(nueva.getMonth() - 1);
        setMesActual(nueva);
      };

      const mesSiguiente = () => {
        const nueva = new Date(mesActual);
        nueva.setMonth(nueva.getMonth() + 1);
        setMesActual(nueva);
      };

      const esHoy = (dia) => {
        if (!dia) return false;
        const hoy = new Date();
        return hoy.getDate() === dia && 
               hoy.getMonth() === mesActual.getMonth() && 
               hoy.getFullYear() === mesActual.getFullYear();
      };

      const tiposEventos = {
        general: { color: 'bg-blue-500', nombre: 'General' },
        clase: { color: 'bg-green-500', nombre: 'Clase' },
        evaluacion: { color: 'bg-red-500', nombre: 'Evaluación' },
        reunion: { color: 'bg-purple-500', nombre: 'Reunión' },
        feriado: { color: 'bg-orange-500', nombre: 'Feriado' }
      };

      if (diaSeleccionado) {
        const fechaKey = formatearFecha(diaSeleccionado);
        const eventosDelDia = eventosCalendario[fechaKey] || [];
        const notasDelDia = notasPlanner[fechaKey] || '';

        return (
          <div className="min-h-screen bg-gray-50 p-4">
            <div className="max-w-2xl mx-auto">
              <div className="flex items-center gap-4 mb-6">
                <button onClick={() => setDiaSeleccionado(null)} className="p-2 hover:bg-gray-100 rounded">
                  <ArrowLeft className="w-6 h-6" />
                </button>
                <div>
                  <h2 className="text-2xl font-bold">{diaSeleccionado} de {meses[mesActual.getMonth()]} {mesActual.getFullYear()}</h2>
                  <p className="text-sm text-gray-600">{diasSemana[new Date(mesActual.getFullYear(), mesActual.getMonth(), diaSeleccionado).getDay()]}</p>
                </div>
              </div>

              <div className="bg-white p-4 rounded-lg shadow mb-4">
                <h3 className="font-bold mb-3">Agregar Evento</h3>
                <div className="space-y-3">
                  <input 
                    type="text"
                    value={textoEvento}
                    onChange={(e) => setTextoEvento(e.target.value)}
                    placeholder="Descripción del evento"
                    className="w-full p-3 border rounded-lg"
                  />
                  <div className="grid grid-cols-2 gap-2">
                    {Object.entries(tiposEventos).map(([key, tipo]) => (
                      <button
                        key={key}
                        onClick={() => setTipoEvento(key)}
                        className={`p-2 rounded-lg font-semibold text-white ${tipo.color} ${tipoEvento === key ? 'ring-4 ring-offset-2 ring-gray-400' : 'opacity-70'}`}>
                        {tipo.nombre}
                      </button>
                    ))}
                  </div>
                  <button 
                    onClick={() => {
                      if (textoEvento.trim()) {
                        const nuevosEventos = { 
                          ...eventosCalendario, 
                          [fechaKey]: [...eventosDelDia, { id: Date.now(), texto: textoEvento, tipo: tipoEvento }] 
                        };
                        setEventosCalendario(nuevosEventos);
                        guardar('eventosCalendario', nuevosEventos);
                        setTextoEvento('');
                        setTipoEvento('general');
                      }
                    }}
                    className={`w-full ${col.p} text-white p-3 rounded-lg font-semibold`}>
                    Agregar Evento
                  </button>
                </div>
              </div>

              <div className="bg-white p-4 rounded-lg shadow mb-4">
                <h3 className="font-bold mb-3">Eventos del Día</h3>
                {eventosDelDia.length === 0 ? (
                  <p className="text-gray-400 text-sm">No hay eventos para este día</p>
                ) : (
                  <div className="space-y-2">
                    {eventosDelDia.map(evento => (
                      <div key={evento.id} className={`p-3 rounded-lg ${tiposEventos[evento.tipo].color} bg-opacity-10 border-l-4 ${tiposEventos[evento.tipo].color} flex justify-between items-center`}>
                        <div>
                          <span className="font-semibold">{evento.texto}</span>
                          <span className="text-xs ml-2 opacity-70">({tiposEventos[evento.tipo].nombre})</span>
                        </div>
                        <button 
                          onClick={() => {
                            const filtrados = eventosDelDia.filter(e => e.id !== evento.id);
                            const nuevosEventos = { ...eventosCalendario, [fechaKey]: filtrados };
                            setEventosCalendario(nuevosEventos);
                            guardar('eventosCalendario', nuevosEventos);
                          }}
                          className="text-red-600 p-1 hover:bg-red-100 rounded">
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              <div className="bg-white p-4 rounded-lg shadow">
                <h3 className="font-bold mb-3">Notas del Día</h3>
                <textarea 
                  value={notasDelDia}
                  onChange={(e) => {
                    const nuevasNotas = { ...notasPlanner, [fechaKey]: e.target.value };
                    setNotasPlanner(nuevasNotas);
                    guardar('notasPlanner', nuevasNotas);
                  }}
                  placeholder="Escribe tus notas, observaciones o recordatorios para este día..."
                  className="w-full p-3 border rounded-lg h-32 resize-none"
                />
              </div>
            </div>
          </div>
        );
      }

      const diasDelMes = obtenerDiasDelMes(mesActual);

      return (
        <div className="min-h-screen bg-gray-50 p-4">
          <div className="max-w-5xl mx-auto">
            <div className="flex items-center gap-4 mb-6">
              <button onClick={irInicio} className="p-2 hover:bg-gray-100 rounded">
                <ArrowLeft className="w-6 h-6" />
              </button>
              <h2 className="text-2xl font-bold flex-1">Planner Mensual</h2>
            </div>

            <div className="bg-white rounded-lg shadow p-4 mb-4">
              <div className="flex items-center justify-between mb-4">
                <button onClick={mesAnterior} className="p-2 hover:bg-gray-100 rounded-lg">
                  <ChevronLeft className="w-6 h-6" />
                </button>
                <h3 className="text-xl font-bold">{meses[mesActual.getMonth()]} {mesActual.getFullYear()}</h3>
                <button onClick={mesSiguiente} className="p-2 hover:bg-gray-100 rounded-lg">
                  <ChevronRight className="w-6 h-6" />
                </button>
              </div>

              <div className="grid grid-cols-7 gap-2">
                {diasSemana.map(dia => (
                  <div key={dia} className={`${col.p} text-white p-2 text-center font-bold text-sm rounded-t-lg`}>
                    {dia}
                  </div>
                ))}
                
                {diasDelMes.map((dia, idx) => {
                  if (!dia) {
                    return <div key={`empty-${idx}`} className="aspect-square"></div>;
                  }

                  const fechaKey = formatearFecha(dia);
                  const eventosDelDia = eventosCalendario[fechaKey] || [];
                  const tieneNotas = notasPlanner[fechaKey]?.trim();
                  const hoy = esHoy(dia);

                  return (
                    <button
                      key={dia}
                      onClick={() => setDiaSeleccionado(dia)}
                      className={`aspect-square border-2 rounded-lg p-2 hover:shadow-lg transition relative ${
                        hoy ? 'border-yellow-400 bg-yellow-50' : 'border-gray-200 hover:border-gray-300'
                      }`}>
                      <div className={`text-lg font-bold ${hoy ? 'text-yellow-600' : ''}`}>{dia}</div>
                      {eventosDelDia.length > 0 && (
                        <div className="flex flex-wrap gap-1 mt-1">
                          {eventosDelDia.slice(0, 3).map(evento => (
                            <div key={evento.id} className={`w-2 h-2 rounded-full ${tiposEventos[evento.tipo].color}`}></div>
                          ))}
                          {eventosDelDia.length > 3 && (
                            <div className="text-xs text-gray-500">+{eventosDelDia.length - 3}</div>
                          )}
                        </div>
                      )}
                      {tieneNotas && (
                        <div className="absolute bottom-1 right-1">
                          <BookOpen className="w-3 h-3 text-gray-400" />
                        </div>
                      )}
                    </button>
                  );
                })}
              </div>
            </div>

            <div className="bg-white rounded-lg shadow p-4">
              <h3 className="font-bold mb-3">Leyenda</h3>
              <div className="grid grid-cols-2 md:grid-cols-5 gap-2">
                {Object.entries(tiposEventos).map(([key, tipo]) => (
                  <div key={key} className="flex items-center gap-2">
                    <div className={`w-4 h-4 rounded ${tipo.color}`}></div>
                    <span className="text-sm">{tipo.nombre}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );

    case 'config-tema':
      return (
        <div className="min-h-screen bg-gray-50 p-4">
          <div className="max-w-2xl mx-auto">
            <div className="flex items-center gap-4 mb-6">
              <button onClick={irInicio} className="p-2 hover:bg-gray-100 rounded">
                <ArrowLeft className="w-6 h-6" />
              </button>
              <h2 className="text-2xl font-bold">Configurar Tema</h2>
            </div>
            <div className="space-y-3">
              {Object.entries(colores).map(([clave, datos]) => (
                <button
                  key={clave}
                  onClick={() => {
                    setTema(clave);
                    guardar('tema', clave);
                  }}
                  className={`w-full p-4 rounded-lg shadow flex items-center gap-3 ${tema === clave ? 'ring-4 ring-offset-2' : ''}`}>
                  <div className={`w-12 h-12 rounded ${datos.p}`}></div>
                  <span className="text-xl font-semibold">{datos.n}</span>
                  {tema === clave && <Check className="w-6 h-6 ml-auto text-green-600" />}
                </button>
              ))}
            </div>
          </div>
        </div>
      );

    case 'lista-escuelas':
      return (
        <div className="min-h-screen bg-gray-50 p-4">
          <div className="max-w-2xl mx-auto">
            <div className="flex items-center gap-4 mb-6">
              <button onClick={irInicio} className="p-2 hover:bg-gray-100 rounded">
                <ArrowLeft className="w-6 h-6" />
              </button>
              <h2 className="text-2xl font-bold">Escuelas</h2>
            </div>
            <div className="bg-white p-4 rounded-lg shadow mb-4 flex gap-2">
              <input 
                type="text"
                value={textoEscuela}
                onChange={(e) => setTextoEscuela(e.target.value)}
                placeholder="Nueva escuela"
                className="flex-1 p-3 border rounded-lg"
